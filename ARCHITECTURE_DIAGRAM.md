# USV Workspace 架构图解

## 1. 系统整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          USV 集群控制系统                                │
└─────────────────────────────────────────────────────────────────────────┘

                    ┌──────────────────────────┐
                    │   地面站 (Ground Station) │
                    │     ROS_DOMAIN_ID = 99    │
                    └────────────┬─────────────┘
                                 │
        ┌────────────────────────┼────────────────────────┐
        │                        │                        │
┌───────▼────────┐      ┌────────▼───────┐      ┌────────▼───────┐
│   USV 01       │      │    USV 02      │      │    USV 03      │
│  Domain ID: 11 │      │  Domain ID: 12 │      │  Domain ID: 13 │
│  IP: .55       │      │  IP: .54       │      │  IP: .52       │
└────────┬───────┘      └────────┬───────┘      └────────┬───────┘
         │                       │                       │
    ┌────▼────┐             ┌────▼────┐            ┌────▼────┐
    │Pixhawk  │             │Pixhawk  │            │Pixhawk  │
    │ FCU 1   │             │ FCU 2   │            │ FCU 3   │
    └─────────┘             └─────────┘            └─────────┘
```

---

## 2. 地面站内部架构

```
┌───────────────────────────────────────────────────────────────────┐
│                      地面站 (ROS_DOMAIN_ID = 99)                   │
├───────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                PyQt5 主窗口 (MainWindow)                 │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐│    │
│  │  │ USV 表格 │  │ 导航面板 │  │ 参数管理 │  │菜单栏   ││    │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬────┘│    │
│  │       │             │             │             │      │    │
│  │  ┌────▼─────────────▼─────────────▼─────────────▼────┐ │    │
│  │  │          ROSSignal (Qt Signal Bridge)            │ │    │
│  │  │  • usv_status_received                           │ │    │
│  │  │  • cluster_task_feedback                         │ │    │
│  │  │  • shutdown_usv                                  │ │    │
│  │  └────────────────────┬─────────────────────────────┘ │    │
│  └───────────────────────┼───────────────────────────────┘    │
│                          │                                     │
│  ┌───────────────────────▼───────────────────────────────┐    │
│  │         GroundStationNode (ROS2 Node)                 │    │
│  │  ┌───────────────┐  ┌───────────────┐  ┌──────────┐ │    │
│  │  │ Subscribers   │  │ Action Client │  │ Services │ │    │
│  │  │               │  │               │  │          │ │    │
│  │  │ • usv_state   │  │ • navigate_to │  │• shutdown│ │    │
│  │  │ • battery     │  │   _point      │  │  _all    │ │    │
│  │  │ • temperature │  │               │  │          │ │    │
│  │  └───────────────┘  └───────────────┘  └──────────┘ │    │
│  └───────────────────────┬───────────────────────────────┘    │
│                          │                                     │
│  ┌───────────────────────▼───────────────────────────────┐    │
│  │              Domain Bridge                            │    │
│  │  • 监听 Domain 99 的话题                              │    │
│  │  • 转发到 Domain 11/12/13                             │    │
│  │  • 双向桥接 13 个话题                                 │    │
│  └───────────────────────┬───────────────────────────────┘    │
└────────────────────────────────────────────────────────────────┘
                           │
                    [跨域通信 UDP]
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
        ▼                  ▼                  ▼
    Domain 11          Domain 12          Domain 13
   (USV 01)           (USV 02)           (USV 03)
```

---

## 3. 单个 USV 内部架构

```
┌─────────────────────────────────────────────────────────────────┐
│                  USV (例如 usv_01, Domain 11)                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────┐      │
│  │           通信与状态管理层 (usv_comm)                │      │
│  │  ┌─────────────────┐  ┌──────────────────────────┐  │      │
│  │  │usv_status_node  │  │navigate_to_point_node    │  │      │
│  │  │(状态聚合发布)    │  │(Action Server 导航)      │  │      │
│  │  └────────┬────────┘  └───────────┬──────────────┘  │      │
│  │  ┌────────▼────────────────────────▼──────────────┐  │      │
│  │  │auto_set_home_node │ gps_to_local_node         │  │      │
│  │  │shutdown_service   │ mock_usv_data             │  │      │
│  │  └──────────────────────────────────────────────┘  │      │
│  └──────────────┬───────────────────────────────────────┘      │
│                 │                                               │
│  ┌──────────────▼───────────────────────────────────────┐      │
│  │              控制层 (usv_control)                     │      │
│  │  ┌───────────────┐  ┌──────────────────────────┐    │      │
│  │  │usv_control_   │  │usv_command_node          │    │      │
│  │  │node (目标点)   │  │(模式切换/解锁)            │    │      │
│  │  └───────┬───────┘  └──────────┬───────────────┘    │      │
│  │  ┌───────▼────────────────────▼──────────────────┐  │      │
│  │  │usv_avoidance_node  │ coord_transform_node    │  │      │
│  │  └─────────────────────────────────────────────┘  │      │
│  └──────────────┬───────────────────────────────────────┘      │
│                 │                                               │
│  ┌──────────────▼───────────────────────────────────────┐      │
│  │              驱动层 (usv_drivers, etc)                │      │
│  │  ┌──────────┐ ┌──────────┐ ┌───────┐ ┌─────────┐   │      │
│  │  │UWB定位   │ │激光雷达  │ │超声波 │ │LED/Sound│   │      │
│  │  └──────────┘ └──────────┘ └───────┘ └─────────┘   │      │
│  └──────────────┬───────────────────────────────────────┘      │
│                 │                                               │
│  ┌──────────────▼───────────────────────────────────────┐      │
│  │              MAVROS (mavros_node)                     │      │
│  │  • 订阅: /mavros/setpoint_position/local             │      │
│  │  • 发布: /mavros/state, /mavros/battery, etc         │      │
│  │  • 服务: /mavros/cmd/arming, /mavros/set_mode        │      │
│  └──────────────┬───────────────────────────────────────┘      │
│                 │                                               │
└─────────────────┼───────────────────────────────────────────────┘
                  │
          [MAVLink 串口通信]
                  │
          ┌───────▼────────┐
          │  Pixhawk 飞控   │
          │  (ArduRover)    │
          │  • GPS          │
          │  • IMU          │
          │  • 电机控制     │
          └────────────────┘
```

---

## 4. 数据流图

### 4.1 状态上报流程

```
┌─────────┐      ┌─────────┐      ┌──────────────┐      ┌─────────────┐      ┌─────────┐
│Pixhawk  │─MAV─▶│ MAVROS  │─ROS─▶│usv_status_   │─ROS─▶│Domain       │─ROS─▶│Ground   │
│  FCU    │Link │  Node   │  2  │node          │  2  │Bridge       │  2  │Station  │
│         │◀─────│         │◀─────│(状态聚合)    │      │(跨域转发)    │      │GUI      │
└─────────┘      └─────────┘      └──────────────┘      └─────────────┘      └─────────┘
    │                │                   │
    │ 心跳 1Hz        │ 位置 30Hz         │ 发布 usv_state 10Hz
    │ 电池 1Hz        │ 速度 10Hz         │
    │ GPS 5Hz         │ 状态 1Hz          │
```

### 4.2 导航控制流程

```
┌─────────┐      ┌─────────────┐      ┌──────────────┐      ┌──────────┐      ┌─────────┐
│Ground   │─目标─▶│Domain       │─转发─▶│navigate_to_  │─计算─▶│usv_      │─设定─▶│Pixhawk  │
│Station  │点   │Bridge       │     │point_node    │位姿 │control_  │点   │  FCU    │
│GUI      │◀反馈──│(跨域转发)    │◀反馈──│(Action       │◀当前──│node      │◀状态──│         │
└─────────┘      └─────────────┘      │ Server)      │位姿 │(20Hz)    │     └─────────┘
                                      └──────────────┘      └──────────┘
                                            │
                                      ┌─────▼─────┐
                                      │监控进度   │
                                      │• 距离     │
                                      │• 航向     │
                                      │• ETA      │
                                      └───────────┘
```

### 4.3 集群任务执行流程

```
┌──────────────────────────────────────────────────────────────────┐
│                    ClusterTaskManager                            │
└─────────────────┬────────────────────────────────────────────────┘
                  │
      ┌───────────┼───────────┐
      │           │           │
      ▼           ▼           ▼
┌──────────┐ ┌──────────┐ ┌──────────┐
│ USV_01   │ │ USV_02   │ │ USV_03   │
│ Step 1   │ │ Step 1   │ │ Step 1   │
└─────┬────┘ └─────┬────┘ └─────┬────┘
      │            │            │
      │ 发送目标    │ 发送目标    │ 发送目标
      ▼            ▼            ▼
┌──────────┐ ┌──────────┐ ┌──────────┐
│ Action   │ │ Action   │ │ Action   │
│ Client   │ │ Client   │ │ Client   │
└─────┬────┘ └─────┬────┘ └─────┬────┘
      │            │            │
      └────────────┼────────────┘
                   │ 收集反馈
                   ▼
        ┌──────────────────┐
        │ 80% 确认?        │
        └─────┬──────┬─────┘
              │ 是   │ 否
              ▼      ▼
        ┌──────────┐ ┌──────────┐
        │下一步    │ │等待/重试  │
        └──────────┘ └──────────┘
```

---

## 5. 通信机制详解

### 5.1 话题订阅关系

```
地面站 (Domain 99):
  订阅:
    /usv_01/usv_state          ← USV 状态
    /usv_01/battery            ← 电池状态
    /usv_01/usv_temperature    ← 温度
    /usv_01/led_state          ← LED 状态
    /usv_01/local_position/*   ← 位置信息
    /usv_01/global_position/*  ← GPS 信息
    ... (总共 13 个话题 × 3 个 USV)

  发布:
    /usv_01/set_usv_target_position  → 目标点
    /usv_01/set_usv_mode             → 模式切换
    /usv_01/set_usv_arming           → 解锁
    /usv_01/set_usv_led              → LED 控制

  服务:
    /usv_01/shutdown_all             → 优雅关闭

  Action:
    /usv_01/navigate_to_point        → 导航目标
```

### 5.2 Domain Bridge 映射

```yaml
# domain_bridge.yaml
topics:
  # 从 Domain 11 → Domain 99
  - name: /usv_01/usv_state
    from_domain: 11
    to_domain: 99
    type: common_interfaces/msg/UsvStatus
    qos: RELIABLE

  - name: /usv_01/local_position/pose
    from_domain: 11
    to_domain: 99
    type: geometry_msgs/msg/PoseStamped
    qos: BEST_EFFORT

  # 从 Domain 99 → Domain 11
  - name: /usv_01/set_usv_target_position
    from_domain: 99
    to_domain: 11
    type: common_interfaces/msg/UsvSetPoint
    qos: RELIABLE

  # ... (共 13 个话题)
```

### 5.3 QoS 策略选择

| 话题类型 | QoS 策略 | 原因 |
|---------|---------|------|
| 位置信息 (pose) | BEST_EFFORT | 高频更新，允许丢包 |
| 状态信息 (state) | RELIABLE | 关键状态，必须送达 |
| 命令控制 (cmd) | RELIABLE | 命令不能丢失 |
| 传感器数据 (sensor) | BEST_EFFORT | 实时性优先 |

---

## 6. 消息接口定义

### 6.1 UsvStatus (核心状态消息)

```
std_msgs/Header header

# 飞控状态
string mode                    # 飞行模式 (GUIDED, HOLD, MANUAL)
bool armed                     # 是否解锁
bool connected                 # 飞控连接状态

# 位置与速度
float64 position_x             # 本地坐标 X (m)
float64 position_y             # 本地坐标 Y (m)
float64 position_z             # 本地坐标 Z (m)
float64 velocity_x             # 速度 X (m/s)
float64 velocity_y             # 速度 Y (m/s)
float64 heading                # 航向角 (度)

# 电池信息
float32 battery_voltage        # 电压 (V)
float32 battery_percentage     # 电量 (%)
float32 battery_current        # 电流 (A)

# GPS 信息
float64 latitude               # 纬度
float64 longitude              # 经度
float64 altitude               # 高度 (m)
int32 satellites_visible       # 可见卫星数

# 目标点信息
float64 target_x               # 目标 X
float64 target_y               # 目标 Y
float64 target_z               # 目标 Z
float64 distance_to_target     # 到目标距离 (m)
bool target_reached            # 是否到达

# 系统信息
float32 system_temperature     # 系统温度 (℃)
string usv_id                  # USV 标识
```

### 6.2 NavigateToPoint Action

```
# Goal
float64 x                      # 目标 X (m)
float64 y                      # 目标 Y (m)
float64 z                      # 目标 Z (m)
float64 yaw                    # 目标航向 (rad)
---
# Result
bool success                   # 是否成功
string message                 # 结果消息
float64 final_distance         # 最终距离
---
# Feedback
float64 distance_to_target     # 当前距离 (m)
float64 heading_error          # 航向误差 (度)
float64 eta_seconds            # 预计到达时间 (秒)
```

---

## 7. 类图 (核心类)

```
┌─────────────────────────┐
│    QMainWindow          │
│  (PyQt5)                │
└────────▲────────────────┘
         │ 继承
┌────────┴────────────────┐
│   MainWindow            │
│  • ui: Ui_MainWindow    │
│  • ros_signal           │
│  • table_manager        │
│  • cluster_controller   │
└────────┬────────────────┘
         │ 组合
    ┌────┴────┐
    │         │
┌───▼─────┐ ┌─▼──────────┐
│ROSSignal│ │TableManager│
│(信号桥) │ │(表格管理)   │
└─────────┘ └────────────┘

┌─────────────────────────┐
│      rclpy.Node         │
└────────▲────────────────┘
         │ 继承
┌────────┴────────────────┐
│ GroundStationNode       │
│  • subscribers          │
│  • action_clients       │
│  • service_clients      │
│  • ros_signal           │
└─────────────────────────┘

┌─────────────────────────┐
│      rclpy.Node         │
└────────▲────────────────┘
         │ 继承
┌────────┴────────────────┐
│  UsvStatusNode          │
│  • state_publisher      │
│  • mavros_subscribers   │
│  • aggregate_state()    │
└─────────────────────────┘

┌─────────────────────────┐
│   ActionServer          │
│   (rclpy.action)        │
└────────▲────────────────┘
         │
┌────────┴────────────────┐
│ NavigateToPointNode     │
│  • execute_callback()   │
│  • monitor_progress()   │
│  • check_arrival()      │
└─────────────────────────┘
```

---

## 8. 序列图 (导航任务)

```
GUI        GS_Node    Domain_    USV_Nav    USV_Ctrl    MAVROS    Pixhawk
                      Bridge     Node       Node
 │           │          │          │           │          │          │
 │ 发送目标   │          │          │           │          │          │
 ├──────────▶│          │          │           │          │          │
 │           │ Action   │          │           │          │          │
 │           │ Goal     │          │           │          │          │
 │           ├─────────▶│          │           │          │          │
 │           │          │ 转发     │           │          │          │
 │           │          ├─────────▶│           │          │          │
 │           │          │          │ 接受 Goal │          │          │
 │           │          │          ├──────────▶│          │          │
 │           │          │          │           │ 计算路径 │          │
 │           │          │          │           │          │          │
 │           │          │          │           │ Setpoint │          │
 │           │          │          │           ├─────────▶│          │
 │           │          │          │           │          │ MAVLink  │
 │           │          │          │           │          ├─────────▶│
 │           │          │          │           │          │          │
 │           │          │          │           │          │◀─────────┤
 │           │          │          │           │          │ 状态反馈  │
 │           │          │          │           │◀─────────┤          │
 │           │          │          │ Feedback  │          │          │
 │           │          │          │◀──────────┤          │          │
 │           │          │ 转发     │           │          │          │
 │           │          │◀─────────┤           │          │          │
 │           │ Feedback │          │           │          │          │
 │           │◀─────────┤          │           │          │          │
 │◀──────────┤          │          │           │          │          │
 │ 显示进度   │          │          │           │          │          │
 │           │          │          │           │          │          │
 │           │          │          │ 到达目标   │          │          │
 │           │          │          │ Result    │          │          │
 │           │          │          ├──────────▶│          │          │
 │           │          │ 转发     │           │          │          │
 │           │          │◀─────────┤           │          │          │
 │           │ Result   │          │           │          │          │
 │           │◀─────────┤          │           │          │          │
 │◀──────────┤          │          │           │          │          │
 │ 显示结果   │          │           │          │          │          │
```

---

## 9. 状态机图 (USV 状态)

```
                    ┌──────────┐
                    │  离线    │◀────────┐
                    │ OFFLINE  │         │
                    └────┬─────┘         │
                         │               │
                    收到心跳              │ 5秒无数据
                         │               │
                    ┌────▼─────┐         │
                ┌──▶│  在线    │─────────┘
                │   │ ONLINE   │
                │   └────┬─────┘
                │        │
                │   收到状态消息
                │        │
                │   ┌────▼─────┐
                │   │  空闲    │
                │   │  IDLE    │
                │   └────┬─────┘
                │        │
                │   收到导航目标
                │        │
                │   ┌────▼─────┐
                └───┤  导航中  │
                    │NAVIGATING│
                    └────┬─────┘
                         │
                    ┌────┴────┐
                    │         │
              到达目标   超时/失败
                    │         │
               ┌────▼─────┐  │
               │  已到达  │  │
               │ ARRIVED  │  │
               └──────────┘  │
                         ┌───▼────┐
                         │  失败  │
                         │ FAILED │
                         └────────┘
```

---

## 10. 部署图

```
┌─────────────────────────────────────────────────────────────┐
│                   本地网络 192.168.68.0/24                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────────┐      ┌──────────────────┐           │
│  │  地面站 PC       │      │  路由器/交换机    │           │
│  │  Ubuntu 22.04    │──────│  192.168.68.1    │           │
│  │  ROS2 Humble     │ Eth  └────────┬─────────┘           │
│  │  Domain 99       │               │                      │
│  └──────────────────┘          WiFi │                      │
│                                      │                      │
│  ┌────────────────┬─────────────────┴──────┬──────────┐   │
│  │                │                        │          │   │
│  │  ┌─────────────▼────────┐  ┌───────────▼────────┐ │   │
│  │  │  gauss01             │  │  gauss02           │ │   │
│  │  │  192.168.68.55       │  │  192.168.68.54     │ │   │
│  │  │  Orange Pi 5         │  │  Orange Pi 5       │ │   │
│  │  │  ROS2 Humble         │  │  ROS2 Humble       │ ... │
│  │  │  Domain 11           │  │  Domain 12         │ │   │
│  │  │  ┌────────────┐      │  │  ┌────────────┐    │ │   │
│  │  │  │ USB 串口   │      │  │  │ USB 串口   │    │ │   │
│  │  │  └────┬───────┘      │  │  └────┬───────┘    │ │   │
│  │  └───────┼──────────────┘  └───────┼────────────┘ │   │
│  │          │                          │              │   │
│  │     ┌────▼─────┐              ┌────▼─────┐        │   │
│  │     │ Pixhawk  │              │ Pixhawk  │        │   │
│  │     │ ArduRover│              │ ArduRover│        │   │
│  │     └──────────┘              └──────────┘        │   │
│  │                                                    │   │
│  │  水面艇本体                   水面艇本体            │   │
│  └────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 11. 技术栈总览

```
┌─────────────────────────────────────────────────┐
│              应用层                              │
│  • PyQt5 (GUI)                                  │
│  • Matplotlib (绘图)                            │
└────────────────┬────────────────────────────────┘
                 │
┌────────────────▼────────────────────────────────┐
│              中间件层                            │
│  • ROS 2 Humble                                 │
│  • MAVROS (MAVLink-ROS2 桥接)                   │
│  • Domain Bridge (跨域通信)                     │
└────────────────┬────────────────────────────────┘
                 │
┌────────────────▼────────────────────────────────┐
│              协议层                              │
│  • DDS (Fast-DDS)                               │
│  • MAVLink 2.0                                  │
│  • 串口协议 (自定义)                            │
└────────────────┬────────────────────────────────┘
                 │
┌────────────────▼────────────────────────────────┐
│              硬件层                              │
│  • Pixhawk 飞控 (ArduRover)                     │
│  • GPS (u-blox M8N)                             │
│  • 激光雷达 (RPLidar A1)                        │
│  • UWB 定位模块                                 │
│  • LED 控制器 (MCU)                             │
│  • 扬声器                                        │
└─────────────────────────────────────────────────┘
```

---

## 总结

本架构图解展示了 USV Workspace 项目的多层次架构：

1. **系统架构**: 地面站 + 多 USV 分布式系统
2. **通信机制**: Domain Bridge 实现跨域通信
3. **数据流向**: 双向数据流，状态上报与命令下发
4. **消息接口**: 清晰定义的 ROS2 消息和 Action
5. **类结构**: 面向对象的模块化设计
6. **状态管理**: 明确的状态机模型
7. **部署拓扑**: 实际的网络和硬件配置

这种分层、模块化的架构设计确保了系统的**可扩展性**、**可维护性**和**可靠性**。
