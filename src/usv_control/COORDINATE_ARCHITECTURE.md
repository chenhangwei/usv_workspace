# USV åæ ‡ç³»ç»Ÿæ¶æ„è¯´æ˜

## ğŸ“ æ¶æ„è®¾è®¡ç†å¿µ

**èŒè´£åˆ†ç¦»**: åæ ‡è½¬æ¢é€»è¾‘ä¸æ§åˆ¶é€»è¾‘åˆ†ç¦»ï¼Œå„å¸å…¶èŒã€‚

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„å¯¹æ¯”

### æ¨¡å¼ 1: å±€éƒ¨åæ ‡æ¨¡å¼ (FRAME_LOCAL_NED)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ground Station â”‚
â”‚   (åœ°é¢ç«™GUI)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ NavigateToPoint Action
         â”‚ (XYZ ç›®æ ‡ç‚¹)
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  navigate_to_point_server  â”‚
â”‚   (Action Server)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ set_usv_target_position
           â”‚ (PoseStamped: X, Y, Z)
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   usv_control_node         â”‚
â”‚  (ç›®æ ‡ç‚¹æ§åˆ¶èŠ‚ç‚¹)           â”‚
â”‚  â€¢ å¤„ç†é¿éšœé€»è¾‘             â”‚
â”‚  â€¢ EKFåŸç‚¹å°±ç»ªæ£€æŸ¥          â”‚
â”‚  â€¢ é£æ§çŠ¶æ€æ£€æŸ¥             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ setpoint_raw/local
           â”‚ (PositionTarget: X, Y, Z)
           â”‚ coordinate_frame = FRAME_LOCAL_NED
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MAVROS                   â”‚
â”‚  (ROS â†” MAVLink Bridge)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ MAVLink
           â”‚ SET_POSITION_TARGET_LOCAL_NED (ID: 84)
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ArduRover é£æ§           â”‚
â”‚  â€¢ EKF å®šä½èåˆ            â”‚
â”‚  â€¢ è·¯å¾„è§„åˆ’                 â”‚
â”‚  â€¢ ç”µæœºæ§åˆ¶                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‰¹ç‚¹**:
- âœ… ç®€å•ç›´æ¥ï¼Œæ— åæ ‡è½¬æ¢å¼€é”€
- âœ… é€‚åˆå®šä½åŸºç«™è¦†ç›–åŒºåŸŸ
- âœ… å¤šUSVåä½œå‹å¥½ï¼ˆç»Ÿä¸€åæ ‡ç³»ï¼‰
- âš ï¸ ä¾èµ– EKF Origin è®¾ç½®

---

### æ¨¡å¼ 2: å…¨å±€GPSåæ ‡æ¨¡å¼ (FRAME_GLOBAL_INT)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ground Station â”‚
â”‚   (åœ°é¢ç«™GUI)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ NavigateToPoint Action
         â”‚ (XYZ ç›®æ ‡ç‚¹)
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  navigate_to_point_server  â”‚
â”‚   (Action Server)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ set_usv_target_position
           â”‚ (PoseStamped: X, Y, Z)
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                          â”‚
           â†“                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  coord_transform_nodeâ”‚   â”‚   usv_control_node       â”‚
â”‚  (åæ ‡è½¬æ¢èŠ‚ç‚¹)       â”‚   â”‚  (ç›®æ ‡ç‚¹æ§åˆ¶èŠ‚ç‚¹)         â”‚
â”‚  ğŸŒ XYZ â†’ GPSè½¬æ¢    â”‚   â”‚  â€¢ å¤„ç†é¿éšœé€»è¾‘           â”‚
â”‚  â€¢ A0åŸºç«™åŸç‚¹        â”‚   â”‚  â€¢ EKFåŸç‚¹å°±ç»ªæ£€æŸ¥        â”‚
â”‚  â€¢ çº¬åº¦/ç»åº¦/æµ·æ‹”    â”‚   â”‚  â€¢ é£æ§çŠ¶æ€æ£€æŸ¥           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ setpoint_raw/global         â†“ setpoint_raw/local
       â”‚ (GlobalPositionTarget)      â”‚ (ç”¨äºé¿éšœç­‰å…¶ä»–åŠŸèƒ½)
       â”‚ coordinate_frame = FRAME_GLOBAL_INT
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MAVROS                   â”‚
â”‚  (ROS â†” MAVLink Bridge)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ MAVLink
           â”‚ SET_POSITION_TARGET_GLOBAL_INT (ID: 86)
           â”‚ â€¢ latitude (int32, deg * 1e7)
           â”‚ â€¢ longitude (int32, deg * 1e7)
           â”‚ â€¢ altitude (float32, ç±³)
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ArduRover é£æ§           â”‚
â”‚  â€¢ GPSä½ç½®è½¬æ¢              â”‚
â”‚  â€¢ è·¯å¾„è§„åˆ’                 â”‚
â”‚  â€¢ ç”µæœºæ§åˆ¶                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‰¹ç‚¹**:
- âœ… é£æ§åŸç”Ÿæ”¯æŒGPSåæ ‡
- âœ… å¤§èŒƒå›´ä»»åŠ¡å‹å¥½ï¼ˆ>10kmÂ²ï¼‰
- âœ… æ— éœ€EKF Originè®¾ç½®
- âš ï¸ ä¾èµ–GPSç²¾åº¦
- âš ï¸ æœ‰åæ ‡è½¬æ¢è®¡ç®—å¼€é”€

---

## âš™ï¸ é…ç½®åˆ‡æ¢

### å¯ç”¨å…¨å±€GPSæ¨¡å¼

ç¼–è¾‘ `usv_bringup/config/usv_params.yaml`:

```yaml
coord_transform_node:
  ros__parameters:
    enable_coord_transform: true          # â† å¼€å¯åæ ‡è½¬æ¢
    use_global_position_target: true      # â† ä½¿ç”¨ GlobalPositionTarget
    gps_origin_lat: 22.5180977
    gps_origin_lon: 113.9007239
    gps_origin_alt: -5.17
```

### ç¦ç”¨å…¨å±€GPSæ¨¡å¼ï¼ˆä½¿ç”¨å±€éƒ¨åæ ‡ï¼‰

```yaml
coord_transform_node:
  ros__parameters:
    enable_coord_transform: false         # â† å…³é—­åæ ‡è½¬æ¢
```

---

## ğŸ“Š æ¨¡å¼å¯¹æ¯”è¡¨

| ç‰¹æ€§ | å±€éƒ¨åæ ‡æ¨¡å¼ | å…¨å±€GPSæ¨¡å¼ |
|------|-------------|------------|
| **åæ ‡ç³»** | ENU (East-North-Up) | GPS (Lat/Lon/Alt) |
| **è½¬æ¢èŠ‚ç‚¹** | âŒ ä¸éœ€è¦ | âœ… coord_transform_node |
| **è¯é¢˜** | setpoint_raw/local | setpoint_raw/global |
| **MAVLink** | SET_POSITION_TARGET_LOCAL_NED | SET_POSITION_TARGET_GLOBAL_INT |
| **EKF Origin** | å¿…éœ€ | å¯é€‰ |
| **é€‚ç”¨èŒƒå›´** | < 10kmÂ² | > 10kmÂ² |
| **è®¡ç®—å¼€é”€** | ä½ | ç¨é«˜ |
| **å¤šUSVåä½œ** | âœ… ä¼˜ç§€ | âœ… è‰¯å¥½ |
| **GPSä¾èµ–** | ä½ï¼ˆä»…ç”¨äºå®šä½ï¼‰ | é«˜ï¼ˆç”¨äºå¯¼èˆªï¼‰ |

---

## ğŸ”§ èŠ‚ç‚¹èŒè´£

### `navigate_to_point_server`
- æ¥æ”¶åœ°é¢ç«™çš„å¯¼èˆªActionè¯·æ±‚
- å‘å¸ƒç›®æ ‡ç‚¹åˆ° `set_usv_target_position`
- ç›‘æ§å¯¼èˆªè¿›åº¦å’Œåé¦ˆ

### `coord_transform_node` (å¯é€‰)
- **ä»…åœ¨å…¨å±€GPSæ¨¡å¼ä¸‹è¿è¡Œ**
- è®¢é˜… `set_usv_target_position`
- XYZ â†’ GPS åæ ‡è½¬æ¢
- å‘å¸ƒåˆ° `setpoint_raw/global`

### `usv_control_node`
- è®¢é˜… `set_usv_target_position`
- å¤„ç†é¿éšœé€»è¾‘
- EKFåŸç‚¹å°±ç»ªæ£€æŸ¥
- é£æ§çŠ¶æ€æ£€æŸ¥
- å‘å¸ƒåˆ° `setpoint_raw/local`

### `MAVROS`
- ROS â†” MAVLink æ¡¥æ¥
- è®¢é˜… `setpoint_raw/local` æˆ– `setpoint_raw/global`
- è½¬æ¢ä¸º MAVLink æ¶ˆæ¯å‘é€ç»™é£æ§

---

## ğŸ¯ æ¨èä½¿ç”¨åœºæ™¯

### ä½¿ç”¨å±€éƒ¨åæ ‡æ¨¡å¼ âœ… (å½“å‰æ¨è)
- å•åŒºåŸŸä½œä¸šï¼ˆ< 10kmÂ²ï¼‰
- é«˜ç²¾åº¦å®šä½åŸºç«™ (A0åŸºç«™)
- å¤šUSVé›†ç¾¤åä½œ
- ä½å»¶è¿Ÿè¦æ±‚
- **å½“å‰é¡¹ç›®é…ç½®**

### ä½¿ç”¨å…¨å±€GPSæ¨¡å¼
- å¤§èŒƒå›´å·¡èˆªï¼ˆ> 10kmÂ²ï¼‰
- è·¨åŒºåŸŸä»»åŠ¡
- æ— å®šä½åŸºç«™ç¯å¢ƒ
- ä¸å…¶ä»–ç³»ç»ŸGPSå¯¹æ¥

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- [åæ ‡ç³»ç»Ÿè®¾è®¡](../../COORDINATE_SYSTEM_DESIGN.md)
- [å…¨å±€GPSæ¨¡å¼æµ‹è¯•æŒ‡å—](TEST_GLOBAL_FRAME.md)
- [EKF OriginéªŒè¯](../../EKF_ORIGIN_VERIFICATION_GUIDE.md)

---

**ç‰ˆæœ¬**: v2.0  
**æ—¥æœŸ**: 2025-11-14  
**æ›´æ–°**: åæ ‡è½¬æ¢é€»è¾‘ç§»è‡³ coord_transform_node
