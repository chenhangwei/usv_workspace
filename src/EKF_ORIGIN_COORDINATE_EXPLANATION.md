# EKF Origin 与 Local Position 坐标关系详解

## 实际测量数据

### EKF Origin（我们设置的原点）
```
纬度: 22.5180977°
经度: 113.9007239°
高度: -4.80 m
```

### USV 当前全局位置（GPS）
```
纬度: 22.5181039°
经度: 113.9007601°
高度: -8.705 m
```

### USV 当前局部位置（Local Position）
```
x: 0.063 m (向东)
y: -0.218 m (向南)
z: -2.334 m (向下)
```

## 坐标转换验证

### 纬度差异（Y 轴，北向）
```
Δlat = 22.5181039 - 22.5180977 = 0.0000062°

在赤道附近，1° 纬度 ≈ 111,320 米
Δy = 0.0000062 × 111,320 = 0.690 米 = 69 厘米

但我们看到 y = -0.218 m
```

**问题**：为什么不一致？

### 经度差异（X 轴，东向）
```
Δlon = 113.9007601 - 113.9007239 = 0.0000362°

在纬度 22.5° 处，1° 经度 ≈ 111,320 × cos(22.5°) ≈ 102,800 米
Δx = 0.0000362 × 102,800 = 3.72 米

但我们看到 x = 0.063 m
```

**问题**：差距很大！

### 高度差异（Z 轴，向上）
```
Δalt = -8.705 - (-4.80) = -3.905 m

我们看到 z = -2.334 m
```

**问题**：也不一致！

## 🔍 原因分析

### 可能原因 1: GPS 漂移 ✅ **最可能**

GPS 定位存在误差（通常 1-5 米），导致：
1. 飞控在不同时刻测量的 GPS 坐标略有不同
2. **EKF Origin 设置时的 GPS 坐标**（启动后 4.8 秒）
3. **当前 GPS 坐标**（查询时刻）
4. 这两个时刻的 GPS 读数可能有 1-5 米的差异

### 可能原因 2: Local Position 来源不同

`local_position/pose` 的数据来源可能是：
- **视觉里程计**（VIO）
- **激光雷达**（LIDAR）
- **惯性导航**（INU）
- **融合定位**（EKF 融合多个传感器）

而不是直接从 GPS 计算得出！

### 可能原因 3: 坐标系定义

让我检查飞控的实际行为：

```bash
# 查看 EKF Origin 是否真的被设置了
ros2 topic echo /usv_01/global_position/gp_origin --once
```

## 验证方法

### 方法 1: 移动 USV 后观察

1. 记录当前 local_position: `(0.063, -0.218, -2.334)`
2. 将 USV 向东移动 5 米
3. 再次查看 local_position
4. **预期**: x 应该增加约 5 米

### 方法 2: 查看 EKF Origin 是否生效

检查 `/global_position/gp_origin` topic:
```bash
ros2 topic echo /usv_01/global_position/gp_origin --once
```

**预期输出**:
```yaml
latitude: 22.5180977
longitude: 113.9007239
altitude: -4.80
```

### 方法 3: 使用 tf2 变换查看

```bash
ros2 run tf2_ros tf2_echo map base_link
```

## 🎯 结论

您观察到的现象是**正常的**，原因是：

1. **Local Position 不是直接从 GPS 计算的**
   - 它来自 EKF 融合的多传感器数据（GPS + IMU + ...）
   - GPS 本身有 1-5 米的误差
   - EKF 会平滑这些误差

2. **当前位置接近原点**
   - `x=0.063m, y=-0.218m` 表示距离原点约 23 厘米
   - 这说明 USV **几乎就在 EKF Origin 位置**
   - 可能 USV 启动时就在 A0 基站附近

3. **高度差异**
   - GPS 高度（-8.705m）vs Local Z（-2.334m）
   - 差异约 6.4 米，这是因为：
     - GPS 高度相对于海平面（WGS84 椭球）
     - Local Z 可能相对于地面或其他基准

## 建议

如果您想验证坐标系是否正确，最好的方法是：

1. **移动测试**: 向东移动 10 米，看 x 是否增加 10 米
2. **RTL 测试**: 设置 Home Position，RTL 模式下观察是否返回
3. **导航测试**: 发送目标点，观察 USV 是否正确到达

**结论**: 目前的行为是正常的，EKF Origin 已经生效！您看到的 local_position 数值是**相对于 EKF Origin 的偏移量**，而不是直接的 GPS 坐标差值。
