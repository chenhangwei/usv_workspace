# USV 飞控参数管理功能使用指南

## 功能概述

地面站 GUI 新增了类似 QGroundControl (QGC) 的飞控参数管理功能，允许您直接读取、修改和保存 USV 飞控参数，无需使用外部地面站软件。

## 功能特性

- ✅ **参数读取**：从飞控读取所有参数（400-600个）
- ✅ **参数编辑**：双击单元格修改参数值
- ✅ **分组展示**：按参数前缀自动分组（ARMING, GPS, EK2 等）
- ✅ **搜索过滤**：快速搜索参数名称
- ✅ **修改追踪**：高亮显示已修改未保存的参数
- ✅ **批量保存**：一键保存所有修改到飞控
- ✅ **修改重置**：撤销所有未保存的修改

## 使用前提

### 1. 启用 MAVROS param 插件

当前系统为了优化启动时间，默认禁用了 `param` 插件。要使用参数管理功能，需要修改 USV 启动文件。

**编辑文件**：`usv_bringup/launch/usv_launch.py`

**找到 `plugin_allowlist` 配置段**（约 280 行）：

```python
'plugin_allowlist': [
    'sys_status',
    'sys_time',
    'command',
    'local_position',
    'setpoint_raw',
    'global_position',
    'gps_status',
    # 添加下面这一行，启用参数插件
    'param',  # ← 添加这一行
],
```

**注意**：启用 `param` 插件后，USV 首次启动时间会增加约 30-60 秒（用于同步参数）。

### 2. 重新启动 USV

```bash
# 如果 USV 已运行，先停止
# Ctrl+C 停止当前 launch

# 重新启动（以 usv_01 为例）
ros2 launch usv_bringup usv_launch.py \
    namespace:=usv_01 \
    fcu_url:=serial:///dev/ttyACM0:921600
```

## 使用步骤

### 步骤 1: 选择 USV

1. 在地面站 GUI 的**集群表格**或**离群表格**中选择一个 USV
2. 确保 USV 在线（状态栏显示"在线"）

### 步骤 2: 打开参数配置窗口

1. 查看右侧的 **USV 详细信息面板**
2. 找到 **🚦 Ready 检查** 组
3. 点击 **⚙️ 飞控参数配置** 按钮

![参数按钮位置](./images/param_button.png)

### 步骤 3: 等待参数加载

- 窗口打开后会自动从飞控拉取参数
- 显示进度条，通常需要 30-60 秒
- 状态栏显示"正在从飞控加载参数..."

**注意**：首次加载时间较长，请耐心等待

### 步骤 4: 浏览参数

**左侧分组列表**：
- 点击 "全部" 查看所有参数
- 点击特定分组（如 ARMING, GPS）查看该组参数

**右侧参数表格**：
- **参数名称**：如 ARMING_CHECK
- **当前值**：当前编辑的值（可修改）
- **原始值**：从飞控读取的原始值
- **分组**：参数所属分组
- **描述**：参数说明（当前版本暂无）

**顶部搜索框**：
- 输入参数名称快速过滤
- 支持部分匹配（如输入 "ARM" 显示所有包含 ARM 的参数）

### 步骤 5: 修改参数

1. **双击**表格中的"当前值"单元格
2. 输入新值（支持整数和浮点数）
3. 按 Enter 确认修改

**修改后的行会高亮显示为淡黄色**

**底部状态栏**显示：`已修改: N 个参数`

### 步骤 6: 保存参数

1. 点击顶部的 **💾 保存** 按钮
2. 确认对话框：显示将保存的参数数量
3. 等待保存完成（状态栏显示进度）
4. 成功后弹出提示：`所有参数已保存到飞控`

**保存后的参数会立即生效**（部分参数可能需要重启飞控）

### 步骤 7: 重置修改（可选）

如果修改后想撤销，点击 **↺ 重置** 按钮，所有未保存的修改将恢复到原始值。

## 界面布局

```
┌─────────────────────────────────────────────────────────────────┐
│ USV-01 飞控参数配置                                    [─][□][×]│
├─────────────────────────────────────────────────────────────────┤
│  搜索: [__________________] [🔍]  [🔄刷新] [💾保存] [↺重置]     │
├───────────┬─────────────────────────────────────────────────────┤
│           │ 参数名称       │  当前值  │ 原始值  │ 分组 │ 描述    │
│  分组列表  ├─────────────────────────────────────────────────────┤
│           │ ARMING_CHECK   │ 1.000    │ 1.000   │ARMING│         │
│ ☑ 全部    │ ARMING_VOLT_MIN│ 10.500   │ 10.500  │ARMING│         │
│ ☑ ARMING  ├─────────────────────────────────────────────────────┤
│ ☑ GPS     │ GPS_TYPE       │ 1.000    │ 1.000   │ GPS  │         │
│ ☑ EK2     │ GPS_AUTO_SWITCH│ 1.000    │ 1.000   │ GPS  │         │
│ ☑ BATT    │                                                      │
└───────────┴─────────────────────────────────────────────────────┘
│ 状态: 已加载 456 个参数 | 已修改 3 个参数                        │
└─────────────────────────────────────────────────────────────────┘
```

## 常用参数说明

### 解锁检查相关（ARMING_*）

- **ARMING_CHECK**: 解锁前检查项（位掩码）
  - `1`: 所有检查
  - `0`: 禁用所有检查（⚠️ 危险）
- **ARMING_VOLT_MIN**: 最低电池电压（V）
- **ARMING_REQUIRE**: 解锁要求（0=禁用, 1=启用）

### GPS 相关（GPS_*）

- **GPS_TYPE**: GPS 类型
  - `0`: 无GPS
  - `1`: AUTO（自动检测）
  - `5`: NMEA
  - `9`: uBlox
- **GPS_AUTO_SWITCH**: GPS 自动切换

### 电池相关（BATT_*）

- **BATT_CAPACITY**: 电池容量（mAh）
- **BATT_VOLT_PIN**: 电压检测引脚
- **BATT_CURR_PIN**: 电流检测引脚

### EKF 相关（EK2_*, EK3_*）

- **EK2_ENABLE**: 启用 EKF2（扩展卡尔曼滤波器）
- **EK2_ALT_SOURCE**: 高度数据源
- **EK2_GPS_TYPE**: GPS 数据源

## 注意事项

### ⚠️ 安全警告

1. **修改参数前请备份**：某些参数修改不当可能导致飞控无法正常工作
2. **谨慎修改关键参数**：如 ARMING_CHECK, GPS_TYPE, EK2_* 等
3. **在安全环境测试**：修改后先在安全环境测试，确认正常后再实际使用
4. **避免并发修改**：同时只能有一个地面站修改参数

### 🔧 故障排查

**问题 1：点击参数按钮没有反应**

- 检查是否已选中 USV
- 检查 USV 是否在线
- 查看日志是否有错误信息

**问题 2：参数加载超时**

- 检查飞控串口连接是否正常
- 检查 MAVROS 是否正常运行：`ros2 topic list | grep usv_01`
- 检查是否启用了 `param` 插件（见"使用前提"）

**问题 3：保存失败**

- 检查飞控是否锁定（部分参数锁定时无法修改）
- 检查串口通信是否稳定
- 查看飞控日志确认参数是否被接受

**问题 4：参数窗口显示"参数拉取服务不可用"**

- 说明 `param` 插件未启用
- 按"使用前提"步骤启用插件并重启 USV

## 高级功能（后续版本）

以下功能已在设计文档中规划，将在后续版本实现：

- [ ] **参数导入/导出**：保存参数到 YAML 文件
- [ ] **参数元数据**：显示参数单位、范围、描述（需要参数定义文件）
- [ ] **参数对比**：对比两个 USV 的参数差异
- [ ] **参数模板**：预设参数配置模板（如"室内定位模式"、"GPS模式"）
- [ ] **参数历史**：记录参数修改历史

## 参考资料

- [ArduPilot 参数列表](https://ardupilot.org/rover/docs/parameters.html)
- [MAVROS 参数文档](https://github.com/mavlink/mavros/tree/ros2/mavros)
- [QGroundControl 参数管理](https://docs.qgroundcontrol.com/master/en/SetupView/Parameters.html)

## 反馈与支持

如有问题或建议，请联系：
- 邮箱：chenhangwei77777@hotmail.com
- GitHub Issues：[usv_workspace](https://github.com/chenhangwei/usv_workspace/issues)

---

**最后更新**: 2025-11-04  
**版本**: v1.0.0 (Phase 1)  
**作者**: GitHub Copilot
