# 参数配置串口模式使用指南

## 📋 概述

参数配置窗口现已支持**两种模式**：

### 1. 🔌 串口直连模式（推荐，新增）

- **直接通过 USB 串口与飞控通信**
- **不依赖 MAVROS** 和 ROS 话题
- **手动连接/断开**，更灵活
- **使用菜单栏**（替代工具栏按钮）
- **独立运行**，不需要 USV 节点启动

### 2. 📡 MAVROS 模式（原有）

- 通过 ROS 话题与 MAVROS 通信
- 需要 USV 节点运行
- 自动连接到选中的 USV
- 使用工具栏按钮

---

## 🚀 快速开始

### **启动方式**

在地面站 GUI 中点击 **"参数配置"** 按钮，会弹出模式选择对话框：

```
┌────────────────────────────────────┐
│   参数配置模式选择                   │
├────────────────────────────────────┤
│ 请选择参数配置模式：               │
│                                    │
│ 🔌 串口直连模式（推荐）             │
│   • 直接通过 USB 串口与飞控通信    │
│   • 不需要 MAVROS 运行            │
│   • 手动连接，更灵活               │
│                                    │
│ 📡 MAVROS 模式                     │
│   • 通过 ROS 话题通信              │
│   • 需要 USV 节点运行              │
│   • 自动连接到选中 USV             │
│                                    │
│  [串口直连模式]  [MAVROS模式]  [取消] │
└────────────────────────────────────┘
```

---

## 🔌 串口直连模式详细说明

### **Step 1: 安装依赖**

```bash
# 安装 pymavlink（MAVLink 协议库）
pip3 install pymavlink

# 安装 pyserial（串口通信库）
pip3 install pyserial

# 添加串口权限（一次性配置）
sudo usermod -a -G dialout $USER
# 重新登录后生效
```

### **Step 2: 连接飞控**

1. 点击菜单栏 **连接(C)** → **🔌 连接飞控...**（或按 `Ctrl+O`）
2. 在连接对话框中配置：

```
┌─────────────────────────────────┐
│  连接到飞控（串口）               │
├─────────────────────────────────┤
│ 串口配置                         │
│   串口设备: /dev/ttyACM0        │
│           [🔄 刷新]              │
│   波特率:   115200              │
│                                  │
│ MAVLink 配置                     │
│   目标系统 ID:   1               │
│   目标组件 ID:   1               │
│                                  │
│ 💡 提示：                        │
│ • 确保飞控已通过 USB 连接到计算机 │
│ • 推荐使用 115200 波特率         │
│ • 系统 ID 通常为 1               │
│                                  │
│         [取消]      [连接]        │
└─────────────────────────────────┘
```

3. 点击 **[连接]** 后，自动加载所有参数

### **Step 3: 使用菜单栏操作**

窗口顶部菜单栏包含所有功能：

#### **连接(C) 菜单**
- **🔌 连接飞控...** (`Ctrl+O`) - 打开连接对话框
- **⛔ 断开连接** - 断开当前连接
- **关闭** (`Ctrl+W`) - 关闭窗口

#### **参数(P) 菜单**
- **🔄 刷新参数** (`F5`) - 重新从飞控加载参数
- **💾 保存修改** (`Ctrl+S`) - 将修改的参数保存到飞控
- **↺ 撤销修改** (`Ctrl+Z`) - 撤销所有未保存的修改
- **📥 导入参数...** - 从文件导入参数
- **📤 导出参数...** - 导出参数到文件

#### **工具(T) 菜单**
- **🔄 重启飞控** - 发送重启命令到飞控
- **🔍 查找参数...** (`Ctrl+F`) - 跳转到搜索框

### **Step 4: 编辑参数**

1. **搜索参数**：在顶部搜索框输入参数名称
2. **选择分组**：左侧列表选择参数分组（如 `ARMING`, `GPS`）
3. **编辑值**：双击 **"当前值"** 列的单元格进行编辑
4. **保存修改**：菜单栏 → 参数 → 💾 保存修改

---

## 📡 MAVROS 模式说明（原有方式）

### **前提条件**

```bash
# 确保 USV 节点已启动
ros2 launch usv_bringup usv_launch.py namespace:=usv_01
```

### **使用流程**

1. 在地面站 GUI 中选择一个在线 USV
2. 点击 **"参数配置"** 按钮
3. 选择 **"MAVROS 模式"**
4. 自动连接到选中 USV 的 MAVROS 参数服务
5. 使用工具栏按钮进行操作

---

## 🆚 两种模式对比

| 特性 | 串口直连模式 | MAVROS 模式 |
|------|-------------|-----------|
| **依赖** | pymavlink, pyserial | MAVROS, ROS 2 |
| **连接方式** | 手动连接 USB 串口 | 自动连接 ROS 话题 |
| **启动要求** | 无需其他节点 | 需要 USV 节点运行 |
| **操作界面** | 菜单栏 | 工具栏按钮 |
| **灵活性** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| **易用性** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **适用场景** | 单机调试、初始配置 | 多机管理、系统集成 |

---

## 🛠️ 常见问题

### **1. 提示"pymavlink 未安装"**

```bash
pip3 install pymavlink
```

### **2. 提示"未检测到串口设备"**

- 检查 USB 线缆是否连接
- 检查飞控是否上电
- 运行 `ls /dev/ttyACM*` 或 `ls /dev/ttyUSB*` 查看设备

### **3. 连接超时**

- 确认波特率是否正确（推荐 115200）
- 确认飞控 `SERIAL0_BAUD` 参数设置（115 = 115200）
- 尝试断电重启飞控

### **4. 参数加载不完整**

- 使用 **菜单 → 参数 → 🔄 刷新参数** 重新加载
- 降低波特率到 57600 再试
- 检查 USB 线缆质量

### **5. 参数保存失败**

- 检查飞控是否已解锁（无法在解锁状态下修改某些参数）
- 某些参数需要重启后生效
- 使用 **工具 → 🔄 重启飞控** 后重新连接

---

## 📝 示例：配置电池参数

### **场景：配置 3S 电池参数**

1. **连接飞控**（串口直连模式）
2. **搜索**：在搜索框输入 `BATT`
3. **编辑参数**：
   - `BATT_CAPACITY` = `5000` (电池容量 5000mAh)
   - `BATT_LOW_VOLT` = `11.1` (低电压 11.1V)
   - `BATT_CRT_VOLT` = `10.5` (临界电压 10.5V)
   - `BATT_VOLT_MULT` = `18.0` (PM07 电压倍率)
   - `BATT_AMP_PERVLT` = `36.0` (PM07 电流倍率)
4. **保存**：菜单 → 参数 → 💾 保存修改
5. **重启**：工具 → 🔄 重启飞控
6. **验证**：重新连接后检查参数是否生效

---

## 🔒 安全提示

⚠️  **修改参数有风险，请谨慎操作：**

- 修改前备份参数：**菜单 → 参数 → 📤 导出参数**
- 不确定的参数不要随意修改
- 重要参数（如电机方向）修改后先在安全环境测试
- 修改安全相关参数（`ARMING_CHECK`）可能导致安全隐患

---

## 📚 相关文档

- **MAVROS 启动优化**: `../usv_bringup/MAVROS_STARTUP_OPTIMIZATION.md`
- **波特率配置指南**: `../usv_bringup/BAUDRATE_CONFIGURATION_GUIDE.md`
- **参数管理总结**: `PARAM_MANAGER_SUMMARY.md`
- **参数使用指南**: `PARAM_USAGE_GUIDE.md`

---

**最后更新**: 2025-11-05  
**功能版本**: 串口模式 v1.0  
**作者**: USV Workspace Team
