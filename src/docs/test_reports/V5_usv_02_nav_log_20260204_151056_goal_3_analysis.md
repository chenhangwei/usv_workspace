# V5 实地测试分析：usv_02 / nav_log_20260204_151056_goal_3.csv

- 日志：`~/usv_logs/V5/usv_02/nav_log_20260204_151056_goal_3.csv`
- 采样：约 10 Hz（中位 dt 0.100s）
- 时长：238.0 s（2381 条）
- 图表输出目录：`~/usv_logs/V5/usv_02/nav_log_20260204_151056_goal_3/`

## 一句话结论
本次导航整体“横向跟踪不错、MPC 求解正常”，且**所有航点均成功到达**（实配阈值 1.5m，实际距离收敛至 1.28~1.46m）。但在 goal 切换瞬间存在数据记录滞后问题，且起步阶段有明显的“对准延迟”现象。

## 关键指标（全局）
- 速度：平均 0.200 m/s，最大 0.334 m/s
- 横向误差（|cross_track_error|）：RMS 0.104 m，最大 0.246 m
- 航向误差（|heading_error_deg|）：平均 16.9°，最大 166.5°
- 航向差（速度航向 - 磁罗盘）：平均 10.3°，最大 179.4°（个别极端点建议结合速度门限理解）
- MPC：平均 15.06 ms，P95 17.02 ms，最大 24.84 ms（性能裕量充足）
- 控制指令：
  - `cmd_vx` ∈ [0.000, 0.200] m/s，触顶比例约 90.3%（多数时间被限幅）
  - `cmd_omega` ∈ [-0.500, 0.500] rad/s，触顶比例约 11.9%（出现一定角速度饱和）

## 到点距离与“切点半径”判断
- 几何距离（target - pose）最小值：**1.278 m**
- **已到达**：本次测试最终距离约 1.28~1.46m，**小于设定的 1.5m 阈值**，判定为成功到达。
- 此时切换到下一 goal：说明航点切换逻辑正常工作（检测到 <1.5m 即切换）。

> 结论更新：系统参数 `nav_arrival_threshold` 实配为 **1.5m**，日志数据显示所有航点均成功进入该范围并触发切换，导航逻辑符合预期。

## 按 goal 分段（使用几何距离 dist_calc）
平均闭合速度 = (dist_start - dist_end) / 段时长

| goal_id | t_start(s) | t_end(s) | 点数 | dist_start(m) | dist_end(m)=min | 平均闭合速度(m/s) |
|---:|---:|---:|---:|---:|---:|---:|
| 3  | 0.0   | 46.0  | 461 | 12.267 | 1.406 | 0.236 |
| 4  | 46.1  | 94.0  | 480 | 12.241 | 1.301 | 0.228 |
| 6  | 94.1  | 141.0 | 470 | 12.154 | 1.465 | 0.228 |
| 8  | 141.1 | 189.0 | 480 | 12.005 | 1.399 | 0.221 |
| 10 | 189.1 | 238.0 | 490 | 12.097 | 1.278 | 0.221 |

解读：每段都能稳定从 ~12m 接近到 ~1.3~1.46m；闭合速度 0.22~0.24m/s，与 `cmd_vx` 长时间触顶（0.2m/s）一致，说明主要受速度上限与姿态对准过程影响。

## 数据一致性/记录问题（建议修复）
- `distance_to_goal` 与几何距离 (target_x/y - pose_x/y) 在 **9/2381** 个点不一致（最大差异 10.92m）。
- 这些点出现在 goal 切换瞬间，表现为：target 已切到下一点，但 distance_to_goal 仍残留上一点距离（或更新顺序不一致）。

> 建议：记录时统一使用几何距离（推荐直接日志中新增 `dist_calc`），或确保在更新 target 后再计算并记录 `distance_to_goal`。

## 航向/控制相关观察
- 航向误差较大区间占比不低（按本次统计，|heading_error|>90° 约 6.4%）。
- `cmd_omega` 约 11.9% 时间触顶 ±0.5 rad/s：当需要快速掉头/对准时出现饱和，可能导致末端更难进一步逼近到 <1m。

> 建议：
> 1) 检查船体实际可达角速度/舵效模型是否与 MPC 内模一致；
> 2) 末端靠近时可降低 `cmd_vx` 上限，增加对准优先级（或提高 Q_theta、适度增大 omega 权重/约束），避免“带角度硬冲”。

## 建议优先查看的图
- `trajectory.png`：整体路径与目标点分布
- `velocity.png`：速度与距离曲线（已改为几何距离）
- `errors.png`：distance / heading_error / cross_track_error
- `control_commands.png`：`cmd_vx/cmd_vy/cmd_omega`
- `mpc_debug.png`：求解时间/代价/预测航向

## 详细问题区间分析 (新增)

### 1. 掉头/对准困难分析 (高误差+饱和区间)
在以下时间段内，USV 检测到 **|航向误差| > 30° 且 |cmd_omega| < 0.45(饱和)**，持续时间均超过 3 秒。这表明在每个 Goal 的起始阶段，USV 都花了很多时间进行原地/低速转向。

| Goal | 时间段 (s) | 持续 (s) | 平均误差 (deg) | 距离变化 (m) | 现象描述 |
|:---:|:---:|:---:|:---:|:---:|:--- |
| **3** | 0.3 - 5.0 | 4.7s | 111.0° | 12.3 -> 12.9 | 起步大幅度转向，距离未减反增(漂移) |
| **4** | 46.4 - 50.0 | 3.6s | 101.0° | 12.2 -> 12.8 | 类似情况，切换目标后立即满舵转向 |
| **6** | 94.4 - 98.9 | 4.5s | 106.3° | 12.2 -> 12.8 | 掉头耗时较长 |
| **8** | 141.4 - 146.0 | 4.6s | 121.7° | 12.0 -> 12.6 | 掉头幅度最大，最费时 |
| **10** | 189.4 - 193.9 | 4.5s | 98.3° | 12.1 -> 12.8 | 转向饱和 |

**诊断**: 每次切换目标约花费 **3.6 ~ 4.7秒** 在纯转向（且伴随距离略微增加，可能是侧向漂移或打转半径导致）。USV 的实际回转能力可能低于 MPC 预期，导致积分饱和或长时间满舵。

### 2. 日志数据不一致点 (Distance Mismatch)
以下时间点确认  严重滞后（记录的是上一 Goal 的结束距离，而 Target 已变为远处的下一 Goal）：

- **t=0.0s**: 差 10.9m (Goal 3)
- **t=46.1-46.2s**: 差 10.8m (切换到 Goal 4 瞬间)
- **t=94.1-94.2s**: 差 10.9m (切换到 Goal 6 瞬间)
- **t=141.1-141.2s**: 差 10.5m (切换到 Goal 8 瞬间)
- **t=189.1-189.2s**: 差 10.7m (切换到 Goal 10 瞬间)

**建议**: 分析代码逻辑，确保  后立即重算  再写入日志，或者在分析时显式过滤掉 mode/goal 切换后 0.5s 内的脏数据。

## 详细问题区间分析 (新增)

### 1. 掉头/对准困难分析 (高误差+饱和区间)
在以下时间段内，USV 检测到 **|航向误差| > 30° 且 |cmd_omega| < 0.45(饱和)**，持续时间均超过 3 秒。这表明在每个 Goal 的起始阶段，USV 都花了很多时间进行原地/低速转向。

| Goal | 时间段 (s) | 持续 (s) | 平均误差 (deg) | 距离变化 (m) | 现象描述 |
|:---:|:---:|:---:|:---:|:---:|:--- |
| **3** | 0.3 - 5.0 | 4.7s | 111.0° | 12.3 -> 12.9 | 起步大幅度转向，距离未减反增(漂移) |
| **4** | 46.4 - 50.0 | 3.6s | 101.0° | 12.2 -> 12.8 | 类似情况，切换目标后立即满舵转向 |
| **6** | 94.4 - 98.9 | 4.5s | 106.3° | 12.2 -> 12.8 | 掉头耗时较长 |
| **8** | 141.4 - 146.0 | 4.6s | 121.7° | 12.0 -> 12.6 | 掉头幅度最大，最费时 |
| **10** | 189.4 - 193.9 | 4.5s | 98.3° | 12.1 -> 12.8 | 转向饱和 |

**诊断**: 每次切换目标约花费 **3.6 ~ 4.7秒** 在纯转向（且伴随距离略微增加，可能是侧向漂移或打转半径导致）。USV 的实际回转能力可能低于 MPC 预期，导致积分饱和或长时间满舵。

### 2. 日志数据不一致点 (Distance Mismatch)
以下时间点确认 `distance_to_goal` 严重滞后（记录的是上一 Goal 的结束距离，而 Target 已变为远处的下一 Goal）：

- **t=0.0s**: 差 10.9m (Goal 3)
- **t=46.1-46.2s**: 差 10.8m (切换到 Goal 4 瞬间)
- **t=94.1-94.2s**: 差 10.9m (切换到 Goal 6 瞬间)
- **t=141.1-141.2s**: 差 10.5m (切换到 Goal 8 瞬间)
- **t=189.1-189.2s**: 差 10.7m (切换到 Goal 10 瞬间)

**建议**: 分析代码逻辑，确保 `update_target()` 后立即重算 `distance_to_goal` 再写入日志，或者在分析时显式过滤掉 mode/goal 切换后 0.5s 内的脏数据。
