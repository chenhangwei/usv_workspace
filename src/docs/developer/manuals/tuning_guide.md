# USV 控制器调试手册

**作者**: chenhangwei
**日期**: 2026-01-26
**适用模块**: `velocity_controller_node` (Offboard 速度控制模式)

## 概述

本手册旨在指导开发人员在实船环境下对 USV 的路径跟踪控制器进行参数调优。目前的控制架构采用了 **Pure Pursuit**（纯追踪）和 **Stanley**（前轮反馈）的混合控制算法。

调优的核心目标是实现：
1.  **直线航行稳定**：无“画龙”或 S 形震荡。
2.  **过弯平滑**：切点适中，无剧烈减速或超调。
3.  **回归迅速**：偏离航线后能快速且平稳地回归。

## 参数配置文件

核心参数位于以下配置文件中：
`src/usv_bringup/config/usv_params.yaml`

定位到 `velocity_controller_node` -> `ros__parameters` 部分。

## 关键参数详解

| 参数名 | 默认值 | 所在算法 | 作用说明 | 调优影响 |
| :--- | :--- | :--- | :--- | :--- |
| **lookahead_distance** | `2.5` | Pure Pursuit | **基准前视距离** (m)。决定船只“看”多远的目标点。 | **调大**: 路径更平滑，抗震荡，但会切角（走内圈）。<br>**调小**: 跟踪更精准，但容易画龙（S形震荡）。 |
| **lookahead_gain** | `0.6` | Pure Pursuit | **速度增益系数**。$L = \text{base} + \text{gain} \times v$。 | **调大**: 高速时看得更远，增加高速稳定性。<br>**调小**: 高速时仍看较近，增加响应灵敏度。 |
| **stanley_gain** | `2.0` | Stanley | **横向误差增益 (k)**。决定船只消除横向偏差的激进程度。 | **调大**: 回正速度快，容易过冲震荡。<br>**调小**: 回正慢，轨迹软绵绵。 |
| **stanley_softening** | `0.15` | Stanley | **低速软化系数**。防止分母为零导致计算数值爆炸。 | 一般保持默认。如果低速起步时这种剧烈摆动，可适当**调大**。 |
| **angular_velocity_filter** | `0.4` | 通用 | **输出低通滤波系数** (0.0~1.0)。 | **值越小 (0.1)**: 滤波越强，舵机动作平滑但滞后。<br>**值越大 (1.0)**: 响应最快，但舵机可能高频抖动。 |
| **cruise_speed** | `0.4` | 通用 | **基础巡航速度** (m/s)。 | 调试初期建议设低 (0.3-0.5 m/s)，系统稳定后再逐步增加。 |

## 实船调优步骤指南

建议在宽阔、无障碍物的水域进行测试，并确保遥控器随时可切回 `MANUAL` 模式接管。

### 第一阶段：准备工作
1.  将 `cruise_speed` 设置为保守值 (例如 **0.4 m/s**)。
2.  规划一条简单的长直线任务（例如 A -> B，距离 > 20m）。

### 第二阶段：Pure Pursuit 调优 (主调直线稳定性)
算法主要在远距离或直线段生效。
1.  **观察现象**: 船只在直线上航行。
2.  **问题 A**: 船只左右摇摆，走出 S 形轨迹（画龙）。
    *   **对策**: **增大** `lookahead_distance` (每次 +0.5m)。
3.  **问题 B**: 船只转弯半径过大，严重切角，或者偏离航线很久才拉回来。
    *   **对策**: **减小** `lookahead_distance` (每次 -0.2m)。

### 第三阶段：Stanley 调优 (主调回正能力)
算法主要在近距离或需要消除横向误差时生效。
1.  **测试方法**: 人为将船开离航线 2-3 米，然后切换到 AUTO/GUIDED 模式，观察其回归航线的表现。
2.  **问题 A**: 船只回归速度太慢，长时间平行于航线航行而不合并。
    *   **对策**: **增大** `stanley_gain` (每次 +0.5)。
3.  **问题 B**: 船只在该回正时猛烈打舵，冲过航线到了另一边（超调）。
    *   **对策**: **减小** `stanley_gain` (每次 -0.2)。

### 第四阶段：整体平滑度 (Filter)
1.  **观察现象**: 听舵机声音或看船头动作。
2.  **问题**: 舵机动作非常细碎、高频抖动。
    *   **对策**: **减小** `angular_velocity_filter` (例如改为 0.2 或 0.1)。
3.  **问题**: 船头响应迟滞，实际上已经偏了但过了一会才转。
    *   **对策**: **增大** `angular_velocity_filter` (例如改为 0.6 或 0.8)。

## 常见问题排查

*   **现象**: 船只一直转圈，无法找到航向。
    *   **检查**: 指南针是否校准？或者如果启用了 `use_velocity_based_heading: true`，确认是否有足够的初始速度让 GPS 算出航向。
*   **现象**: 到达航点附近后不停转圈，无法触发到达。
    *   **检查**: `goal_tolerance` (到达阈值) 是否设置得太小？建议至少设置为船长的 1-1.5 倍（例如 0.8m - 1.5m）。
