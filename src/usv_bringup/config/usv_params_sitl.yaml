# =============================================================================
# USV SITL 仿真模式参数覆盖文件
# 
# 用法: 在 sitl_launch.py 中替换或追加到 usv_params.yaml
#       也可以手动运行时指定:
#       ros2 launch usv_bringup usv_launch.py \
#           simulation_mode:=sitl \
#           fcu_url:=tcp://127.0.0.1:5760 \
#           param_file:=/path/to/usv_params_sitl.yaml
#
# ⚠️ 注意: 此文件中的 gps_origin 必须与 SITL 启动位置一致！
# =============================================================================

# Auto Set Home 参数（SITL 中 GPS 立即收敛，缩短延迟）
/**/auto_set_home_node:
  ros__parameters:
    set_delay_sec: 3.0                      # SITL GPS 秒定位，3 秒足够
    use_current_gps: true                   # 使用 SITL 当前模拟 GPS 位置

# GPS 坐标转换（使用 SITL 默认 Canberra 位置）
# ⚠️ 如果你改了 SITL 启动位置，这里也要同步修改！
/**/gps_to_local_node:
  ros__parameters:
    gps_origin_lat: 22.5180977              # 与 SITL --custom-location 一致
    gps_origin_lon: 113.9007239             # 与 SITL --custom-location 一致
    gps_origin_alt: 0.0
    publish_rate: 10.0
    enable_gps_to_local: true
    coordinate_yaw_offset_deg: 0.0

/**/coord_transform_node:
  ros__parameters:
    gps_origin_lat: 22.5180977
    gps_origin_lon: 113.9007239
    gps_origin_alt: 0.0
    enable_coord_transform: true
    use_global_position_target: true

# =============================================================================
# SITL 仿真 MPC 速度控制器参数覆盖
# 
# Gazebo 仿真中船舶动力学响应比实船更快,需要更小的 tau_omega
# 以避免模型失配导致的 S 形振荡
#
# 调参记录 (SITL):
#   2026-02-08: 基于 nav_log_20260208_180233_goal_2.csv 分析
#     问题: tau 过大(1.2~1.5s) + w_max 过小(0.35) → 振荡 0.32Hz + 饱和 37%
#     方案: 降低 tau 适配仿真响应速度, 放宽 w_max, 增大 R_dw 抑制振荡
# =============================================================================
/**/velocity_controller_node:
  ros__parameters:
    # MPC 权重参数 (SITL 调优)
    mpc_weight_pos: 10.0                    # Q_pos: 位置权重 (保持不变)
    mpc_weight_heading: 8.0                 # Q_theta: 航向权重 (保持不变)
    mpc_weight_steering: 20.0               # R_w: 转向惩罚 ↑↑ (8→20, 抑制S形高频震荡)
    mpc_weight_steering_rate: 40.0          # R_dw: 转向速率惩罚 ↑↑ (25→40, 强制平滑角速度输出)
    mpc_weight_cte: 12.0                    # Q_cte: 横向偏差权重 (15→12, 降低以减少过度纠偏引起的震荡)
    
    # v5 转向时间常数 (SITL 仿真船响应更快, 需要更小的 tau)
    mpc_tau_omega: 0.4                      # 基础 tau_omega (0.4s, 匹配仿真响应)
    
    # v6 速度自适应 tau_omega (关键调优: 大幅降低以适配仿真)
    adaptive_tau_enabled: true
    tau_omega_low_speed: 0.6                # 低速 tau: 仿真低速转向仍较快
    tau_omega_high_speed: 0.3               # 高速 tau: 仿真高速舵效好
    tau_speed_threshold_low: 0.10           # 低速阈值
    tau_speed_threshold_high: 0.30          # 高速阈值
    
    # 速度与角速度限制
    max_angular_velocity: 0.5               # w_max: 仿真中放宽以消除饱和
    cruise_speed: 0.30                      # 巡航速度 ↓ (0.4→0.30, 降速减震)
    min_speed: 0.15                         # 最小速度: 允许更低速转弯
    
    # v8 AMPC 参数 (SITL 调优)
    ampc_enabled: true
    ampc_rls_forgetting_factor: 0.99        # RLS 遗忘因子 ↑ (0.97→0.99, 更稳定的τ估计)
    ampc_heading_observer_alpha: 0.18       # 航向滤波 ↓ (0.3→0.18, 平滑ω观测减少噪声激励)
    ampc_tau_min: 0.15                      # τ 下限
    ampc_tau_max: 1.5                       # τ 上限
    ampc_rebuild_threshold: 0.15            # τ 变化重建阈值
    ampc_saturation_tau_boost: 1.02         # 饱和升压因子
